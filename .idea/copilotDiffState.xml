<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/BE/payment-service/payment-service/src/main/java/com/datt/paymentservice/config/SecurityConfig.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/BE/payment-service/payment-service/src/main/java/com/datt/paymentservice/config/SecurityConfig.java" />
              <option name="originalContent" value="package com.datt.paymentservice.config;&#10;&#10;// (Lưu ý: Đảm bảo import filter từ package của service này)&#10;import com.datt.paymentservice.filter.JwtTokenFilter;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.http.HttpMethod; // &lt;-- Thêm import này&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;&#10;import org.springframework.security.config.http.SessionCreationPolicy;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;&#10;&#10;@Configuration&#10;@EnableWebSecurity&#10;public class SecurityConfig {&#10;&#10;    // Use constructor injection to avoid null/autowiring timing issues&#10;    private final JwtTokenFilter jwtTokenFilter;&#10;&#10;    public SecurityConfig(JwtTokenFilter jwtTokenFilter) {&#10;        this.jwtTokenFilter = jwtTokenFilter;&#10;    }&#10;&#10;    @Bean&#10;    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {&#10;        http&#10;                .csrf(org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer::disable)&#10;                .sessionManagement(session -&gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))&#10;&#10;                .authorizeHttpRequests(authorize -&gt; authorize&#10;                        // Allow CORS preflight&#10;                        .requestMatchers(HttpMethod.OPTIONS, &quot;/**&quot;).permitAll()&#10;&#10;                        // 1. API &quot;Tạo đơn hàng&quot; (POST): Chỉ Bệnh nhân (PATIENT) được gọi&#10;                        .requestMatchers(HttpMethod.POST, &quot;/api/v1/payments/create-order&quot;).hasRole(&quot;PATIENT&quot;)&#10;&#10;                        // 2. API &quot;Capture&quot; (GET): Ai cũng được vào (Vì đây là link PayPal gọi lại)&#10;                        .requestMatchers(HttpMethod.GET, &quot;/api/v1/payments/capture-order&quot;).permitAll()&#10;&#10;                        // 3. Khóa tất cả các API còn lại&#10;                        .anyRequest().authenticated()&#10;                );&#10;&#10;        // Thêm bộ lọc JWT&#10;        http.addFilterBefore(jwtTokenFilter, UsernamePasswordAuthenticationFilter.class);&#10;&#10;        return http.build();&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.datt.paymentservice.config;&#10;&#10;// (Lưu ý: Đảm bảo import filter từ package của service này)&#10;import com.datt.paymentservice.filter.JwtTokenFilter;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.http.HttpMethod; // &lt;-- Thêm import này&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;&#10;import org.springframework.security.config.http.SessionCreationPolicy;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;&#10;&#10;@Configuration&#10;@EnableWebSecurity&#10;public class SecurityConfig {&#10;&#10;    // Use constructor injection to avoid null/autowiring timing issues&#10;    private final JwtTokenFilter jwtTokenFilter;&#10;&#10;    public SecurityConfig(JwtTokenFilter jwtTokenFilter) {&#10;        this.jwtTokenFilter = jwtTokenFilter;&#10;    }&#10;&#10;    @Bean&#10;    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {&#10;        http&#10;                .csrf(org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer::disable)&#10;                .sessionManagement(session -&gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))&#10;&#10;                .authorizeHttpRequests(authorize -&gt; authorize&#10;                        // Allow CORS preflight&#10;                        .requestMatchers(HttpMethod.OPTIONS, &quot;/**&quot;).permitAll()&#10;&#10;                        // 1. API &quot;Tạo đơn hàng&quot; (POST): Chỉ Bệnh nhân (PATIENT) được gọi&#10;                        .requestMatchers(HttpMethod.POST, &quot;/api/v1/payments/create-order&quot;).hasRole(&quot;PATIENT&quot;)&#10;&#10;                        // 2. API &quot;Capture&quot; (GET): Ai cũng được vào (Vì đây là link PayPal gọi lại)&#10;                        .requestMatchers(HttpMethod.GET, &quot;/api/v1/payments/capture-order&quot;).permitAll()&#10;&#10;                        // 3. Khóa tất cả các API còn lại&#10;                        .anyRequest().authenticated()&#10;                );&#10;&#10;        // Thêm bộ lọc JWT&#10;        http.addFilterBefore(jwtTokenFilter, UsernamePasswordAuthenticationFilter.class);&#10;&#10;        return http.build();&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>